name: Ingestion Deployment

on:
  push:
    branches: [main]

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: "read"
      id-token: "write"
    outputs:
      image_name: ${{ steps.build.outputs.image_name }}

    steps:
      - uses: actions/checkout@v3

      - id: "auth"
        name: "Authenticate to GCP"
        uses: "google-github-actions/auth@v1"
        with:
          workload_identity_provider: "${{ secrets.WORKLOAD_IDENTITY_PROVIDER }}"
          service_account: "${{ secrets.SERVICE_ACCOUNT }}"

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2

      - id: build
        name: Build and push with Kaniko
        uses: docker/build-push-action@v4
        with:
          context: .
          file: ./cloud-run/data-ingestion/Dockerfile
          push: true
          tags: |
            europe-west1-docker.pkg.dev/${{ steps.auth.outputs.project_id }}/ingestion/latest:${{ github.sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          platforms: linux/amd64

      - name: Set image name output
        id: set_output
        run: echo "image_name=us-central1-docker.pkg.dev/${{ steps.auth.outputs.project_id }}/ingestion/latest:${{ github.sha }}" >> $GITHUB_OUTPUT

  deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: "read"
      id-token: "write"

    steps:
      - uses: actions/checkout@v3

      - id: "auth"
        name: "Authenticate to GCP"
        uses: "google-github-actions/auth@v1"
        with:
          workload_identity_provider: "${{ secrets.WORKLOAD_IDENTITY_PROVIDER }}"
          service_account: "${{ secrets.SERVICE_ACCOUNT }}"

      - name: "Set up Cloud SDK"
        uses: "google-github-actions/setup-gcloud@v1"

      - name: "Use gcloud CLI [test]"
        run: "gcloud info"

      - name: Make deploy script executable
        run: chmod +x ./infrastructure/deploy-ingestion.sh

      - name: Run deploy script with image name
        run: ./deploy.sh ${{ needs.build.outputs.image_name }} ${{ secrets.SERVICE_ACCOUNT }}
